.. _AtoZem1dfm_lateral:

.. include:: <isonum.txt>


Laterally Constrained 3D Inversion
==================================

Here, frequency-domain data are inverted using the laterally constrained 3D
inversion approach. Just like in the previous exercise, every 1D model is
associated with a distinct sounding location (see `EM1DFM package overview
<http://em1dfm.readthedocs.io/en/latest/content/overview.html>`__). However
lateral constraints are added such that the set of recovered 1D models are
smooth horizontally and can ultimately be constrained and interpreted in 3D.
The laterally constrained 3D inversion algorithm is a computationally fast way
to invert FEM data while taking into account both vertical and horizontal
variability of the Earth.

.. figure:: .\..\..\..\images\AtoZ_fem1d\LC_landing.png
    :align: center
    :scale: 75%

As part of this exercise, the user will:

    - :ref:`Set<AtoZem1dfm_lateral_setup>` relevant inversion parameters
    - :ref:`Invert<AtoZem1dfm_lateral_inversion>` the field observations using a set of laterally constrained 1D conductivity models (susceptibility models can be included)
    - :ref:`Interpret<AtoZem1dfm_lateral_discussion>` the inversion results generated by the algorithm

.. _AtoZem1dfm_lateral_setup:

Setup for the Exercise
----------------------

**If you have completed the tutorial** :ref:`"Static and Adaptive 1D Inversion"<AtoZem1dfm_static>`:

    - Open your preexisting GIFtools project
    - :ref:`Set the working directory <projSetWorkDir>` (if you would like to change it)

**If you have NOT completed the previous tutorial and would like to start here, complete the following steps:**

    - `Download the demo <https://github.com/ubcgif/GIFtoolsCookbook/raw/master/assets/AtoZ_FEM1D_4Download.zip>`_
    - Open GIFtools
    - :ref:`Set the working directory <projSetWorkDir>`
    - :ref:`Import raw FEM data <importFemData>` (1D FEM GIF format data in ppm)
    - :ref:`Import the topography data <importTopo>` (3D GIF format)
    - :ref:`Import 1D mesh<importMesh>` (layers file)
    - :ref:`Create elevation from surface topography<objectElevFromSurface>`
        - Set elevation at 40 m above topography
        - :ref:`Set i/o header<objectSetioHeaders>` for Z to the elevation column you just created.


.. figure:: .\..\..\..\images\AtoZ_fem1d\dataPlot5000.png
    :align: center
    :width: 700

    Real component of the magnetic field at f = 5000 Hz (left). Imaginary component of the magnetic field at f = 5000 Hz (right)

.. _AtoZem1dfm_lateral_inversion:

Laterally Constrained 3D FEM Inversion
--------------------------------------

.. figure:: .\..\..\..\images\AtoZ_fem1d\LC_fem1D.png
    :align: right
    :scale: 75%

Here, the set of FEM data are inverted using the laterally constrained 3D
approach.

Setup the inversion
^^^^^^^^^^^^^^^^^^^

**If you have completed the tutorial** :ref:`"Static and Adaptive 1D Inversion"<AtoZem1dfm_static>`:

    - Click on a preexisting EM1DFM inversion object and :ref:`copy options<invCopyOptions>`
    - Click on the newly created EM1DFM inversion object to set the output directory
    - Set any necessary EM1DFM inversion parameters under :ref:`edit options<invEditOptions>`:
        - Make sure the mesh, observed data and topography are properly set!
        - Mode: Laterally constrained 3D with *Max distance* = 1000 m, *Number of stations* = 16 and smoothing parameter = 100

**If you have NOT completed the previous tutorial and are starting here:**

    - :ref:`Create an EM1DFM inversion object <createFEMInv>` and set the output directory
    - Set the EM1DFM inversion parameters under :ref:`edit options<invEditOptions>`:
        - **Global tab**:
            - Set mesh from drop-down menu
            - Set observed data from drop-down menu
            - Mode: Laterally constrained 3D with *Max distance* = 1000 m, *Number of stations* = 16 and smoothing parameter = 100
            - Model options: for this example, data are inverted strictly for a conductivity model
            - Solver options: leave as default or customize
            - Trade-off Mode: set to discrepancy principle
        - **Conductivity tab:**
            - Leave as default or customize
        - **Susceptibility tab:**
            - Leave as default or customize (if being used)
        - Click apply and write all files


.. note:: If you chose not to write the files from the edit options menu, you may do so through :ref:`write inversion files <invWriteAll>`


Run Inversion and Load Results
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

    - :ref:`Run inversion <invRun>`
    - Results are loaded automatically for this algorithm
    - :reF:`View the results <viewData>`

.. _AtoZem1dfm_lateral_discussion:

Discussion
^^^^^^^^^^

**! IMAGE OF RESULTS AND DISCUSSION. MUST RE-RUN INVERSION AFTER BUG WITH BETA**


Laterally Constrained with Hard Constraints
-------------------------------------------

**! ADD THIS IF WE WANT**


























